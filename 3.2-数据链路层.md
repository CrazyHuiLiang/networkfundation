# 数据链路层

>OSI参考模型中的第二层，介于物理层和网络层之间。设立数据链路层的目的是在物理层提供的物理链路连接和比特流传输功能的基础上，为网络层之间建立、维持和释放点－点间数据链路连接并为传输提供方法，简言之，数据链路层的存在将一条原始的、有差错的物理链路变为无差错的逻辑数据链路。




##3.3.1 数据链路层功能

###1 帧同步功能
数据链路层传输数据的单元成为帧，他是对物理层传输的比特流按一定格式分割形成的信息块。将数据这样分块传输的好处是在传输出错时，只要将存在差错的帧重传一次，不必将全部数据重新发送，提高了数据的传输效率。帧同步就是将接收方可以从接收到的比特流中准确地区分出一帧的开始和结束，确定出帧的边界。
（1）字节计数法
	特殊字符表征一帧的起始，专门字段表明字节数。DEC的数字数据通信报文协议DDCMP：
SOH是帧起始，Count共14位，表示数据长度，必须是字节的整数倍，CRC1、CRC2是标题部分和数据部分的校验字段，标题部分单独校验。可以实现数据的“透明”传输。
（2）使用字符填充的首位定界符法
特定的字符定界帧起始和结束，为保证“透明”传输，在一些数据字符前须加转义字符，使用不便，IBM的二进制同步协议（BSC）采用此法。
（3）使用比特填充的首尾标志法
以一组特定的比特序列标志帧的开始和结束。HDLC采用此法。例如：固定的比特组合“01111110”，是HDLC中帧的起始定界符和终止定界符。在其它字段也能正常传输“01111110”比特序列，分别在发送方和接收方采用0比特插入和删除技术，发送方对非标志字段的比特序列进行处理，在每5位连续的“1”后自动插入一位“0”，接收方在接收比特序列的同时对序列进行检测，当检测到“011111”后，如果接下来一位是“0”，则自动删除这一位。 
（4）违法编码法
在一些物理层采用特定的比特编码方法时采用。如曼码中，“高-高”“低-低”电平对结合来定界帧的起始和终止。

后两种方法更常用。

###2 差错控制功能
由于信道中干扰的存在，就会不可避免地出现数据传输错误，数据链路层可以通过纠错或检错重发两种办法实现差错控制，差错控制还包括传输中帧丢失和帧重复接收的处理。为解决帧丢失的问题，一般引入定时器；为防止帧重复，每个帧都加上序号。

###3 流量控制功能
发送方发送速率大于接收方接收速率时，为避免由于过载而造成的数据丢失而采取的控制措施。

###4 链路管理
链路两端的节点在进行通信之前，发送端需要知道接收端是否处于准备接收状态。为此，通信双方必须预先交换一些必要的信息，从而建立起数据链路连接。在数据传输阶段要维持这一数据链路连接。在数据传输结束后还要释放这一连接。数据链路的建立、维持和释放称为链路管理。







##3.3.2 差错控制
发送方确认接收方是否正确收到由它发送数据的方法称为反馈差错控制。

###1 反馈检测法
也叫“回声”法，接收方收到信息后，按照原样返回，发送方判断，若相符，说明正确；否则，发送方发出一个控制字符，通知接收方删除错帧。
原理简单，实现容易，可靠性高，但信道利用率低。
###2 自动重发请求法（ARQ法）
简单来说，自动请求重发ARQ（Automatic Request for Repeat）就是在接到正确数据时，接收方发送ACK，在接收到出错数据时，接收方发出否定应答帧NAK（negative acknowledgement），发送方接收到NAK后，自动重发数据。
（1）空闲重发请求
也叫停止等待ARQ方式，发送后等待，确认正确后再发。
实现过程：
发送方每次仅当前信息帧作为待确认帧留在缓冲区中，当发送方开始发送信息帧时，随即启动计时器；
当接收方收到无差错的信息帧时，即向发送方返回一个确认帧；
当接收方检测到一个含有差错的信息帧时，便舍弃该帧；
若发送方在规定时间内收到确认帧，即将计时器清零，继而开始下一帧的发送；
若发送方在规定时间内未收到确认帧，则应重发存于缓冲器内的确认信息帧。
只需一帧的存储空间，但信道利用率低。
（2）连续重发请求
发送方允许在没收到ACK帧的情况下将窗口中的数据帧连续传送出去。信道利用率提高，需要更大的缓冲存储空间。
实现过程：
	1》 发送方连续发送信息帧而不必等待确认帧的返回
	2》发送方在重发表中保存所发送的每个帧的备份
	3》重发表按先进先出（FIFO）队列规则操作
	4》接收方对每一个正确收到的信息帧返回一个确认帧
	5》每一个确认帧包含一个唯一的序号，随相应的确认帧返回
	6》接收方保存一个接收次序表，它包含最后正确收到的信息帧的序号
	7》当发送方收到相应信息帧的确认后，从重发表中删除该信息帧的备份
	8》当发送方检测出失序的确认帧（即第n号信息帧和第n+2号信息帧的确认帧已返回，而n+1号的确认帧未返回）后，便重发未被确认的信息帧。
	
上述过程中，如果出错，则有Go-back-N、选择重发两种策略。

Go-back-N策略
如果一个数据帧出错或丢失，则发送方将这一个数据帧以及这一数据帧后已经发出的所有数据帧全部重传。
选择重发策略
不是将出错或丢失后的数据帧全部重发，而是重发出错或丢失的数据帧。


##3.3.3 流量控制
由于干扰原因或者发送方的数据发出速度大于接收方对数据的处理速度，会出现整个码组的丢失，从而造成传输出错。这时，就需要一系列技术保证发、收双方在发、收数据速度上的协调以及一旦出现差错后正确处理，一般称为流量控制。

###1 XON／XOFF方案
使用控制字XON、XOFF控制流量，接收方过载时发送XOFF，发送方接到后暂停发送，待收到发来的XON后，再继续发送。可以用较小的空间解决双方速度差异。
例如，打印机
###2 窗口机制
滑动窗口是指发送方和接收方创建的发送和接收缓冲区。
（1）发送方窗口
传输开始时，发送方窗口处于最大状态，有n-1个帧，表明这时可以连续发送n-1帧数据，随着数据的发送，如果没有收到ACK帧，窗口边界移动，每发出一帧，窗口的大小就减1，说明可以连续发出的数据帧变小；收到ACK帧后，窗口大小加1。
（2）接收方窗口
与发送方不同的是接收方窗口中不是接收的数据帧，而是为接受数据帧保留的存储空间。
初始时，这一空间也为n-1，表明这时可以连续接收n-1帧数据，随着数据的到来，如果没有发出ACK帧，也就是还没有将数据取走，窗口边界移动，每到来一帧，窗口的大小就减1，发出ACK后，窗口大小加1。

##3.3.4 数据链路控制协议举例
链路控制协议包括异步协议和同步协议，异步协议在数据量大时效率低，一般用于低速场合；同步协议以帧为单位，可分为面向字符的同步控制协议和面向比特的同步控制协议。
###1 面向字符的同步控制协议
IBM的二进制同步通信协议BSC
链路层协议由链路建立、数据传输、链路拆除组成，为完成管理，加入传输控制字符：
	SOH： 序始，报文标题信息的开始；
	STX： 文始，标题信息结束，文本开始；
	ETX： 文终，文本结束；
	ENQ： 询问，远程请求；
	ACK： 确认，接收发出对正确接收报文的响应；
	DLE： 转义，修改后面紧跟字符的意义；
	NAK： 否认，接收发出对没有正确接收报文的响应；
	SYN： 同步字符，用于同步；
	ETB： 块终或组终，数据块的结束。
	
报文分：数据报文和监控报文
数据报文由报头和文本组成。报头是控制信息，文本是数据信息。长数据可以分成多个数据块。
###2 面向比特的同步控制协议
HDLC是在IBM提出的SDLC（Synchronous Data Link Control）的基础上制订的，它支持点到点和多点链路上的半双工和全双工通信，可以通过站点类型、链路配置、传输模式、帧结构及工作过程等几个方面对HDLC进行描述

站点类型
	主站（Primary station），在链路中具有完全控制功能的设备或节点，它能够主动完成命令的发送、链路管理、流量控制等工作；
	从站（Secondary station），是链路中不能完成主站功能的设备和节点，它能够接收主站的命令，并响应主站的命令；
	复合站（Combined station），在链路中既可以作为主站又可以作为从站，既可以发送命令又可以响应命令。

当主站希望从从站接收数据时，它将询问从设备是否有数据待发送，这种情况成为轮询；
当主站希望发送数据或命令时，他要告知从站准备好接收数据，这种情况成为选择；

链路配置
非平衡配置（主从配置），链路中具有一个主站设备、一个或多个从站设备；
平衡配置，点到点拓扑中的两个站点都是复合型的。
通信方式

HDLC支持正常响应、异步响应和异步平衡三种通信模式。

非平衡配置支持两种通信模式：
	正常响应模式、异步响应模式
正常响应模式（NRM）：主站负责链路层的逻辑连接，初始化和差错控制，并能发起向从站的数据传输和命令传输，从站只有在主站向他探询后才能发起一个或多个响应帧；
异步响应模式（ARM）：在这种模式中，主从站的关系以及主站的功能都和正常响应模式相同，而从站可以不需主站探寻即发送响应。

在平衡结构中只有异步平衡（ABM）一种模式：
每个复合站可以平等地发起数据传输，而不需要得到对方复合站的允许。

HDLC的帧结构
	由开始标志字段、地址字段、控制字段、帧检验序列字段和结束标志字段组成。


